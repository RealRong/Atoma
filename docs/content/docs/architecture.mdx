---
title: Architecture
description: Atoma 核心架构与 demo 页面如何组合
---

## 核心组件
- **Store / Atom Map**：每个资源一个 `Map<id, Entity>`，通过 Jotai `PrimitiveAtom` 暴露给 React。
- **QueueManager**：收集 CRUD 操作并按 id 合并。
- **OperationApplier**：在内存应用操作，生成 patches / inversePatches / changedFields。
- **AdapterSync**：乐观/严格模式写适配器，成功记录历史，失败回滚。
- **IndexManager**：Number/String/Text 索引 + Top-K 排序，支撑 `findMany` 本地查询。
- **StoreRegistry**：集中注册多资源，`Store('name')` 惰性创建。

## 适配器
- **SQLiteHttpAdapter**：轻量 HTTP（演示用），支持 limit/offset/cursor 与简单过滤。
- **IndexedDBAdapter**：Dexie 本地存储，findMany 走本地 applyQuery；游标分页快速路径。
- **HybridAdapter**：本地 + 远端双写/读策略。
- **InMemoryAdapter（demo）**：小数据、本地过滤示例。

## 模式与策略
- **乐观模式**：先写 atom，适配器成功后触发 onSuccess，失败回滚。
- **严格模式**：适配器成功后才写 atom。
- **fetchPolicy**：`local` / `remote` / `cache-and-network`。
- **skipStore**：大列表/瞬时查询可不落地缓存。

## Demo 页面如何组合
- **IndexedDB Playground**：`DemoStore` + `useFindMany` + 可编辑的 `FindManyOptions` 代码区。
- **SQLite Big List**：`SQLiteHttpAdapter` + 20k 行分页过滤，展示大列表下少样板。
- **Registry Local Filters**：StoreRegistry + InMemoryAdapter，展示多类型切换与本地索引过滤。

## 数据流（写入）
`addOne/updateOne/deleteOne` → Queue → OperationApplier → AdapterSync  
乐观：先 set atom → adapter 成功 → onSuccess；失败 → rollback + onFail  
严格：adapter 成功 → set atom → onSuccess
